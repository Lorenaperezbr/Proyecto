---
title: 'Estudio de circulación vehicular en Montevideo: febrero-marzo 2021'
author: ''
date: ''
output: bookdown::pdf_document2 
  df_print: paged
header-includes: \usepackage{float} \floatplacement{figure}{H}
lang: "sp"
---
```{r setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Librerías utilizadas
library(dplyr)
library(date)
library(lubridate)
library(ggplot2)
library(tidyverse)
library(kableExtra)
library(rgdal)
library(maptools)
library(sf)
library(GGally)
library(data.table)
library(gridExtra)
```

```{r data_source, echo = FALSE, include = FALSE}
# Carga deL join
base <- readRDS("data/processed/febrero_marzo_join.rds")

# carga del shapefile
municipios <- st_read("data/geo/mdeo_barrios")
st_crs(x = municipios) <-  5382
```

```{r manejo_fechas, echo = FALSE, include = FALSE}
# Preparamos los datos
base$fecha <- ymd(base$fecha)  

base$fecha <- format(as.Date(base$fecha), '%Y-%m-%d')

base$hora <- hms(base$hora)
```

```{r categorizacion, echo = FALSE, include = FALSE}
# Categorizamos las horas en mañana (8-12), tarde (12-17), media tarde (17-20), noche (20-00) y madrugada (00-8)

base$cat_hora <- ifelse(base$hora >= "08H 00M 0S" & base$hora < "12H 00M 0S",
                        "Mañana",
                        ifelse(base$hora >= "12H 00M 0S" & base$hora < "17H 00M 0S",
                               "Medio dia",
                               ifelse(base$hora >= "17H 00M 0S" & base$hora < "20H 00M 0S",
                                      "Media tarde",
                                      ifelse(base$hora >= "20H 00M 0S" & base$hora < "23H 59M 59S",
                                             "Noche",
                                             "Madrugada"
                                      )
                               )
                        )
)

base$cat_hora <- factor(base$cat_hora,
                        levels = c("Madrugada",
                                   "Mañana",
                                   "Medio dia",
                                   "Media tarde",
                                   "Noche"),
                        ordered = T)


base$cat_fecha <- ifelse(
  (base$fecha >= "2021-02-01" &
     base$fecha <= "2021-02-10") |
    (base$fecha >= "2021-03-01" & base$fecha <= "2021-03-10"),
  "Principio de mes",
  ifelse((base$fecha >= "2021-02-11" &
            base$fecha <= "2021-02-20") |
           (base$fecha >= "2021-03-11" &  base$fecha <= "2021-03-20"),
         "Mitad de mes",
         "Fin de mes"
  )
)

base$cat_fecha <- factor(base$cat_fecha,
                         levels = c("Principio de mes",
                                    "Mitad de mes",
                                    "Fin de mes"),
                        ordered = T)

      
base$dia_semana <- factor(wday(base$fecha),
                          labels = c("1" = "Domingo",
                                     "2" = "Lunes",
                                     "3" = "Martes",
                                     "4" = "Miercoles",
                                     "5" = "Jueves",
                                     "6" = "Viernes",
                                     "7" = "Sabado"))

base <- subset(base, select = -c(hora,
                                 dsc_avenida,
                                 dsc_int_anterior,
                                 dsc_int_siguiente,
                                 i.dsc_avenida,
                                 i.dsc_int_anterior,
                                 i.dsc_int_siguiente))

base$CCZ <- factor(base$CCZ, levels = c(1:17))
```

\begin{center}
\begin{LARGE}
	Nuevas Tecnologías para el análisis de datos
	\vspace{1cm}
	


	Autores:
	Federico Golffeld - Martín Olivera - Lorena Pérez - Ángela Vieyto
	
	\vspace{1cm}
	
	
	`r Sys.Date()`
	
\end{LARGE}
\end{center}	

\vspace{5cm}


\newpage



# Inroducción

En general se ha observado una tendencia creciente en la circulación vehicular en las ciudades (https://negocios.elpais.com.uy/noticias/venta-autos-cero-kilometro-aumento-marzo-marcas-compradas.html). Esto se puede asociar directamente a un mayor volumen de vehículos, lo que genera mayores tiempos de circulación, enlentecimiento de la movilidad urbana y mayores posibilidades de cometer faltas o accedentes de tránsito, cuando las ciudades no logran adaptarse a dicha coyuntura. Por otro lado, y vinculado a lo anterior, un mayor volumen de vehículos conlleva a un enlentecimiento en los tiempos de movilidad, que genera un comportamiento espontáneo de los conductores en usar como regulación de este fenómeno, la velocidad de circulación. Por parte de las autoridades de las ciudades se ha hecho continuos esfuerzos por combatir esta problemática con estrictas regulaciones a la velocidad y control vehicular . El estudio de la relación existente entre el conteo vehicular y la velocidad de circulación ha sido estudiada, por ejemplo en que proporción se reduce la velocidad promedio conforme varía la cantidad de vehículos. Naranjo-Torres, D. (2015) encuentran que para la ciudad de Bogotá la presencia de un nuevo vehículo en circulación reduciría la velocidad promedio  entre 1,37 km/h y 1,68 km/h.


En particular, en la capital del país, la Intendencia de Montevideo (IM) a partir de su Departamento de Movilidad en conjunto con el Ministerio de Transporte y Obras Públicas (MTOP) son quienes se encargan de este tipo de regulaciones, no solo a nivel de calles sino de cartelería y señalizaciones, muchas veces a partir de la incorporación de un sistema de monitoreo digital con vídeo en ciertos puntos de la ciudad. El Centro de Gestión de Movilidad (CGM) de la IM es quien se encarga de esta tarea, monitoreando y tomando registro de lo acontecido a partir de las cámaras de vídeo-vigilancia. Los principales objetivos se basan en mejorar la fluidez y los tiempos de viajes, así como regular los potenciales accidentes que se puedan generar. (https://montevideo.gub.uy/centro-de-gestion-de-movilidad)

"Es la puesta en marcha de diversos Sistemas Inteligentes de Transporte aplicados en tiempo real a la administración, gestión y control del tránsito y del transporte de la ciudad." (CGM - Intendencia de Montevideo. https://montevideo.gub.uy/centro-de-gestion-de-movilidad).

En cuanto a la velocidad de circulación, un exceso que no sea controlado por parte de las autoridades puede potenciar fallos humanos agravando potenciales siniestros de tránsito. Por tanto, en el departamento de Montevideo rige una reglamentación de velocidad máxima de 45 km/h, mientras que en caso que se indique lo contrario, se puede determinar máximos a niveles más bajos o más altos. "La única excepción es donde la señalización indica otras alternativas". En concreto, se ha observado algunas particularidades que motivan la formulación de políticas de regulación vehicular, como: la baja probabilidad de sobrevivencia ante siniestro a velocidades mayores a 60 km/h. (Fuente: https://www.gub.uy/unidad-nacional-seguridad-vial/comunicacion/publicaciones/volante-hay-limites-velocidad)

Por esto, el objetivo general de este trabajo se basa en un estudio de las velocidades de los vehículos que circulan en Montevideo en conjunto con la cantidad de vehículos que se logran capturar a partir del CGM. En particular surge el interés de estudiar geográficamente los volúmenes de circulación y su asociación con las velocidades registradas. Por otro lado, estudiar aquellos puntos con mayores registros de velocidad y aquellos con menores registros a fin de capturar la potencial necesidad de regulación en ciertos puntos de la capital. Estos elementos en su conjunto pueden contribuir a la detección de potenciales aplicaciones de políticas departamentales que cumplan con un mayor fluidez vehícular y un tráfico más seguro, alineándose a los objetivos propuestos a priori por el CGM.

En lo que sigue de este trabajo se propone realizar una descripción de los datos a utilizar en términos de su fuente de obtención, tipos de datos, cantidad de observaciones, variables, entre otras. Luego se desarrolla un análisis exploratorio de los datos a fin de lograr explicar los objetivos pautados anteriormente a partir de visualización estadística y en particular, en la sección 4 se desarrolla la aplicación propuesta en R-Shiny (qué se puede encontrar en ella y cuál es su principal contribución). Finalmente se presentar las conclusiones de este informe así como lineamientos futuros. 


\newpage


# Datos

Para realizar este estudio se consideran datos brindados por el Centro de Gestión de Movilidad (CGM) del Departamento de Movilidad de la Intendencia de Montevideo (IM). Se cuentan con datos con frecuencia mensual referentes a la velocidad de circulación y el volumen de circulación de vehículos en la ciudad de Montevideo donde se detallan los registros de las cámaras de CGM con día y horario de lo acontecido. Se consideran datos para los meses de Febrero y Marzo de 2021 - "El sistema genera un registro cada 5 minutos, las medidas que se explican a continuación corresponden a la suma de todos los vehículos de los 5 minutos anteriores a la fecha y hora del registro. También se publican datos particulares del sensor que permiten conocer su ubicación y entender el sentido de circulación que se está midiendo" (https://catalogodatos.gub.uy/dataset/intendencia-montevideo-velocidad-promedio-vehicular-en-las-principales-avenidas-de-montevideo). Cabe destacar la particularidad de que en los meses de verano la movilidad suele ser inferior a otros meses del año y considerando un contexto de pandemia, estos datos pueden estar afectados a la coyuntura.

Por tanto, se cuenta con 7623354 observaciones correspondiente a Febrero y Marzo de 2021 para cada una de las bases de datos utilizadas: la velocidad de circulación vehicular y el volumen de circulación. En cuanto al set de variables consideradas, los datos vinculados a la velocidad de circulación cuenta con 10 variables mientras que los datos de conteo vehicular cuenta con 11 observaciones. Sin embago, considerando que hay variables idénticas en ambas fuentes de datos, en total se cuenta con 12 variables. La siguiente tabla base el set de variables consideradas en este estudio con su debida descripción. 

```{r, echo = FALSE}
variables <-
  c(
    "i..cod_detector",
    "id_carril",
    "fecha",
    "hora",
    "dsc_avenida",
    "dcs_int_anterior",
    "dsc_int_siguiente",
    "latitud",
    "longitud",
    "velocidad_promedio",
    "volume",
    "volumen_hora")

descripcion <-
  c(
    "Id de la cámara que está monitoerando un determinado carril",
    "Número del carril que se está monitoreando",
    "Día en que se toma la base",
    "Hora en que se toma la base",
    "Nombre de la vía en la que se mide el tránsito",
    "Nombre de la vía que forma el cruce desde donde vienen los vehículos",
    "Nombre de la vía que forma el cruce donde está el medidor",
    "Latitud de donde está el medidor",
    "Longitud de donde está el medidor",
    "Promedio de  las velocidades de los autos que circularon por el carril durante los últimos 5 minutos",
    "Cantidad de vehículos detectados en el carril en los últimos 5 minutos",
    "Cantidad de vehículos detectados en el carril en la última hora"
  )

tabla_variables <- data.frame(cbind(variables, descripcion))

colnames(tabla_variables) <- c("Variables", "Descripción")

tabla_variables %>%
  kable(booktabs = T,
        caption = "Tabla resumen de las variables del set de Datos") %>%
    kable_styling(latex_options = c("striped", "hold_position"))
```

Respecto a las variables anteriores, la longitud y la latitud son variables de tipo "float", mientras que las vías son textos y las restantes son variables numéricas en el conjunto de los números enteros, a excepción de aquellas vinculadas a días y horas. Estas variables tienen un formato propio y fueron cohesionadas a formato `Date` para su correcto tratamiento. Dada la gran cantidad de observaciones con las que contamos, decidimos categorizar las variables fecha y hora, en ambas bases, de la siguiente forma: 

```{r echo = FALSE}
categorias <-
  c(
    "Principio de mes",
    "Mitad de mes",
    "Fin de mes",
    "Mañana",
    "Medio día",
    "Media tarde",
    "Noche",
    "Madrugada"
  )

descripcion_2 <- c(
  "Del 1 al 10 de cada mes",
  "Del 11 al 20 de cada mes",
  "Del 21 al 28 en el caso de Febrero, y del 21 al 31 en el caso de Marzo",
  "De las 8.00 a las 12.00",
  "De las 12.01 a las 17.00",
  "De las 17.01 a las 20.00",
  "De las 20.01 a las 00.00",
  "De las 00.01 a las 7.59"
)

tabla_variables2 <- data.frame(cbind(categorias, descripcion_2))

colnames(tabla_variables2) <- c("Categorización", "Descripción")

tabla_variables2 %>%
  kable(booktabs = T,
        caption = "Tabla resumen de las categorías creadas para Fecha y Hora") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

A partir de una tabla de frecuencias se obtiene que el 32% de los vehículos capturados por las cámaras (variables volumen y velocidad) ocurren a principio de mes, el 33% sobre mediados de mes y un 35% sobre fin de mes.

En cuanto al volumen de vehículos capturado por la cámara en los últimos 5 minutos, se observa un promedio total de 17 vehículos, mientras si discriminamos por mes, se obtiene un promedio de 16 y 17, para febrero y marzo, respectivamente. Por otro lado, se observa una velocidad promedio de 30.9 km/h si se toma en cuenta la totalidad de las observaciones, mientras que asciende levemente a 31.0 km/h para el mes de febrero y se ubica en 30.8 km/h para el mes de marzo. Los resultados siguen esta misma línea si consideramos la categorización anteriormente mencionada para la fecha de los registros; 30.8km/h para los primeros 10 días del mes, 31.0 km/h para mitad de mes y fin de mes.  

Por último, observamos los desvíos de las variables Volumen y Velocidad promedio, y luego la correlación entre ambas. La primera  tiene una desviación estándar de 18.6 vehículos, mientras que la segunda una de 17.0 km/h. Mirando el coeficiente de correlación, se observa que este es de 0.02, indicando una correlación baja, lo que podrá llegar a ser contra intuitivo.

# Análisis Exploratorio

A partir de los objetivos planteados y de los datos obtenidos por el centro de gestión de movilidad se puede contar con datos de conteo y velocidad promedio de vehículos para los meses de Febrero y Marzo de 2021. Unificando los datos se puede realizar entonces, análisis exploratorio en términos de los indicadores de interés. En particular, haciéndo especial énfasis en la relación existente entre la velocidad promedio y el conteo vehícular e incorporando luego, información geográfica para localizar no solo los detectores de CGM sino también los registros según detector. Para ello, se propoen herramientas de visualización a partir de gráficos (usando librerías como ggplot2, maptools, sf, GGally) y luego, el desarrollo de una aplicación a partir de R-Shiny.

## Análisis de la relación entre conteo vehícular y velocidad promedio

Para el análisis exploratorio, en primer lugar se puede realizar una descripción en función de los dos indicadores principales en este informe: el conteo y la velocidad promedio de circulación vehicular. 

Cuando se observa a partir de un diagrama de dispersión la velocidad promedio y el volumen de vehiculos, este se puede observar para todos los datos registrados, así como según ciertas categorizaciones. La Figura \@ref(fig:dispersion1) muestra la relación, al menos de asociación existente entre los indicadores antes mencionados. A partir de la misma se pueden realizar dos observaciones: en primer lugar, que la relación entre ambos indicadores es positiva, aludiendo a que ante mayor cantidad de vehículos en circulación, mayor se observa la velocidad promedio. Esto aunque no parecería intuitivo a priori, puede asociarse a incrementos en la dinámica de circulación donde a fin de evitar potenciales aglomeraciones vehiculares, los sitios con mayor acumulación de vehículos se puede vincular con registros de velocidad promedio algo superiores. Otra observación viene dada por la categorización según momento del día. En esta línea, la noche y la madrugada parecen ser los momentos del día que mayor explican la relación encontrada anteriormente, mientras que durante el día y la tarde, como se esperaría a priori, la relación observada entre la cantidad de vehículos y sus velocidades tienen una relación no tan clara. 

```{r dispersion1, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Nube de puntos de la cantidad de vehículos y la velocidad promedio capturadas por las cámaras de CGM, según categoría horaria del día"}
base %>%
  ggplot(aes(x = volume,
             y = velocidad_promedio)) +
  geom_point(alpha = 1/3) +
  labs(x = "Cantidad de vehículos detectados", 
       y = "Velocidad promedio") +
  theme(aspect.ratio = 1,
        legend.title = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.x = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.y = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.text.x = element_text(size = 8,
                                   angle = 45,
                                   hjust = 1)
        ) +
  facet_wrap( ~cat_hora,
              ncol = 5) +
  geom_smooth(method = "lm")


```
En segundo plano, este mismo diagrama de dispersión permite categorizarse por días de la semana. Previo a la observación de los datos, se esperaría que no existan sustanciales diferencias cuando se consideran los días de la semana, debido a que el flujo de vehículos entre semana sería similar (más aún en Montevideo), pudiéndose esperar una relación más clara durante los días del fin de semana.

```{r dispersion2, echo=FALSE, warning=FALSE, message=FALSE,fig.cap="Nube de puntos de la cantidad de vehículos y la velocidad promedio capturadas por las cámaras de CGM, según día de la semana."}


base %>%
  ggplot(aes(x = volume,
             y = velocidad_promedio)) +
  geom_point(alpha = 1/3) +
  labs(x = "Cantidad de vehículos detectados", 
       y = "Velocidad promedio") +
  theme(aspect.ratio = 1,
        legend.title = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.x = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.y = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.text.x = element_text(size = 8,
                                   angle = 45,
                                   hjust = 1)
        ) +
  facet_wrap( ~dia_semana,
              ncol = 3) +
  geom_smooth(method = "lm")

```
En este sentido, la Figura \@ref(fig:dispersion2) efectivamente se alinea a lo hipotetizado anteriormente donde no parece existir diferencias importantes entre los días de la semana, siendo los fines de semana aquellos días donde la relación entre velocidad y conteo mantiene una mayor correlación positiva.

Análogamente a lo anterior, la Figura \@ref(fig:dispersion3) muestra que en términos del momento del mes la relación de asociación encontrada es positiva y no varía de forma sustancial a traves de las franjas diarias durante los meses. 

```{r dispersion3, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Nube de puntos de la cantidad de vehículos y la velocidad promedio capturadas por las cámaras de CGM, según momento del mes"}


base %>%
  ggplot(aes(x = volume,
             y = velocidad_promedio)) +
  geom_point(alpha = 1/3) +
  labs(x = "Cantidad de vehículos detectados", 
       y = "Velocidad promedio") +
  theme(aspect.ratio = 1,
        legend.title = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.x = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.y = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.text.x = element_text(size = 8,
                                   angle = 45,
                                   hjust = 1)
        ) +
  facet_wrap( ~cat_fecha,
              ncol = 3) +
  geom_smooth(method = "lm")


```
A partir de lo anterior, parece clara la existencia de relaciones de asociación positiva entre velocidad y conteo. Sin embargo, la magnitud de la correlación observada y su nivel de significación no se puede observar a partir de las figuras anteriores. La Figura \@ref(fig:correlaciones) muestra las correlaciones cruzadas entre la velocidad promedio y la cantidad de vehículos categorizando en función de lo presentado anteriormente y obteniendo el coeficiente de correlación lineal entre ambos indicadores para todos los datos así como para cada categoría. Algo en común es que, las correlaciones en todos los casos es significativa estadísticamente y con signo positivo asociado a que incrementos en la cantidad de vehículos se vincula con mayores velocidades promedio. Se observa que la correlación es mayor durante la noche, los días sábado y domingo y durante el principio de mes. Sin embargo, no se observan importantes discrepancias cuando se considera la correlación para todos los datos.

```{r correlaciones, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Correlaciones y densidades del volumen y la velocidad promedio de vehículos según categoría horaria, día de la semana y momento del mes"}
ggpairs(base, c("volume", "velocidad_promedio"),
        mapping = ggplot2::aes(color = cat_hora,
                               alpha = 0.5),
        diag = list(continuous = wrap("densityDiag")),
        lower = list(continuous = wrap("points",
                                       alpha = 0.9)),
        labeller = as_labeller(c("volume" = "Cantidad de vehículos",
                                 "velocidad_promedio" = "Velocidad Promedio"))
        )
        

ggpairs(base, c("volume", "velocidad_promedio"),
        mapping = ggplot2::aes(color = dia_semana,
                               alpha = 0.5),
        diag = list(continuous = wrap("densityDiag")),
        lower = list(continuous = wrap("points",
                                       alpha = 0.9)),
        labeller = as_labeller(c("volume" = "Cantidad de vehículos",
                                 "velocidad_promedio" = "Velocidad Promedio"))
        )

ggpairs(base, c("volume", "velocidad_promedio"),
        mapping = ggplot2::aes(color = cat_fecha,
                               alpha = 0.5),
        diag = list(continuous = wrap("densityDiag")),
        lower = list(continuous = wrap("points",
                                       alpha = 0.9)),
        labeller = as_labeller(c("volume" = "Cantidad de vehículos",
                                 "velocidad_promedio" = "Velocidad Promedio"))
        )
```
Un segundo aspecto a explorar viene dado por lo que se observa en la diagonal principal de los trés gráficos de la figura anterior. Se observa la densidad de los datos, las cuales muestran la frecuencia de observaciones que se observan en cada nivel de las variables en cuestión. Esto permite ver valores más frecuentes (modo), asimestrías, valores medios, entre otros. En cuanto a las velocidades promedio, se observa que hay mayores observaciones en velocidades promedio muy bajas (esto puede deberse a que las cámaras capturan vehículos estacionados o reduciéndo sus velocidades debido a que están en semáforos o esquinas. Se puede asociar a vehículos parados, o frenando o acelerando), o en valores debajo del máximo permitido en la capital (45 km/h). Sin embargo, existe cierta asimetría asociada a observaciones con registros con altas velocidades. Observando por momento del día, como parece intuitivo, la noche y la madrugada son los momentos con mayores registros a velocidades más altas, mientras que las distribuciones a la tarde tienen mayores frecuencias a velocidades comparativamente inferiores. En cuanto a velocidades, cuando se observa por día de la semana o por categoría del mes no se observan diferencias en cuanto a la distribución de los datos. En cuanto al conteo, se observan mayores registros durante el día (en particular media tarde, sobre los días jueves).

A continuación se propone incluir al análisis información geográfica permitiendo localizar las observación en función de la localización de las cámaras de CGM según Centro Comunal Zonal (CCZ)

## Información geográfica


Previo a la descrpción de los datos incorporando la localización geográfica de los mismo, la Figura \@ref(fig:mapa) muestra la localización de los detectores del CGM dentro de Montevideo dividiendo según CCZ. Los datos recolectados cuentan con 110 cámaras ubicadas en Montevideo y vienen representados a partir de puntos en el mapa de la figura que sigue. Se encuentra que los radares se encuentran concentrados en la zona céntrica de Montevideo, en particular, en los CCZ de los municipios, B, C, CH, E, y generalmente sobre las arterias principales de la ciudad (en particular, se encuentra gran cantidad de cámaras sobre Bvar. Artigas y Av. Italia). Sin embargo, también es notorio que hay zonas de la capital donde no hay radares o hay un radar solo, o que en general hay menor cantidad que en zonas más céntricas. Esto parece tener sentido en términos de los puntos de mayor participación ciudadana (Centro, Cordon, Pocitos, Buceo, Tres Cruces, etc) donde es necesaria una mayor regulación y cuidado en lo que concierne a la velocidad de los vehículos asociado a la cantidad de vehículos que circulan. 

Sin embargo, esto debe tomarse en consideración a la hora de considerar en particular, el conteo vehicular por CCZ, debido a que hay algunos que registran muchos menos vehículos debido a que la zona no cuenta con demasiadas cámaras. Adicionalmente, también sería pertinente notar que donde mayor concentración hay de cámaras, mayor chances hay de que un mismo vehículo cruce más de una cámara en su circuito y se registre más de una vez (eso sumado a que de por sí, ya hay mayor flujo vehicular).

```{r mapa, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Mapa de Montevideo particionado según CCZ localizando las cámaras del CGM"}

ggplot() +
  geom_sf(data = municipios) +  
  geom_sf(data = base) +
  theme_minimal()
```

El siguiente cuadro resume en términos de volume y velocidad promedio el mínimo y el máximo de cada indicador discriminando según CCZ a fin de denotar zonas donde el tráfico es mayor y donde los niveles de velocidades promedios se encuentran por fuera de lo establecido a nivel departamental. Se observa que la velocidad máxima en todos los CCZ excede los límites permitidos, incluso superan los 60 km/h. El CCZ 5 ubicado en la zona de Punta Carretas (Municipio CH) es el que tiene el mayor registro en términos de velocidad y también en términos de conteo vehicular. Esto merece especial atención al tratarse de una zona comercial, muy habitada y por tanto, muy transitada. Sería conveniente contar con esta información a fin de tener insumos para regular estos aspectos y alinearse a los objetivos departamentales. 

```{r, message=FALSE, warning=FALSE}
base %>%
 group_by(CCZ) %>%
  summarise(velocidad_minima = min(velocidad_promedio),
            velocidad_maxima = max(velocidad_promedio),
            volumen_minimo = min(volume),
            volumen_maximo = max(volume))%>%xtable()
```

En línea al estudio localizando las observaciones según CCZ, la Figura \@ref(fig:boxplot) muestra la distribución de la velocidad promedio y el conteo vehicular distinguiendo según CCZ a partir de un diagrama de caja ordenado según la mediana de los datos según CCZ. Vale recordar que la caja representa al rango intercuartílico (RI) de la distribución, los bigotes superiores e inferiores representan 1.5 veces el RI y los puntos por fuera, datos considerados atípicos. 

```{r boxplot, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Distribución del volumen y la velocidad promedio de los vehículos discriminando por Centro Comunal Zonal (CCZ)"}
p1 <- base %>%
        ggplot(aes(x = reorder(factor(CCZ), -velocidad_promedio, median),
                   y = velocidad_promedio)) +
        geom_boxplot() +
        labs(x = "Centro comunal zonal",
             y = "Velocidad Promedio")

p2 <- base %>%
        ggplot(aes(x = reorder(factor(CCZ), -volume,median),
                   y = volume)) +
        geom_boxplot() +
        labs(x = "Centro comunal zonal",
             y = "Conteo de Vehiculos") 

grid.arrange(p1, p2, nrow = 1, ncol = 2)

```

En cuanto a la velocidad promedio se observa que el CCZ 10, 17 y 8 son aquellos donde la mediana de las velocidades promedio es mayor. Estos CCZ pertenecen a distintos municipios y se asocian a distintas partes de la ciudad (municipio F, A y E - Maroñas, Cerro, Carrasco, respectivamente). El CCZ 17 aunque es el único que no presenta datos atípicos presenta una caja más grande y por lo tanto los datos contenidos dentro de su rango intercuartílico son más volátiles en comparación al resto de los zonales. Los CCZ 16 y 1 (municipio B y C, Centro y Aguada, respectivamente) son aquellos con menores mediana en términos de sus velocidades promedios registradas. Estos últimos CCZ en términos de conteo vehicular se asocian a con una mediana de volúmen baja aludiendo a lo observado anteriormente donde la velocidad y el volumen se correlacionan positivamente. La observación es análoga observando los tres CCZ mencionados al comienzo. Estas asociaciones no son estrictas, pero mantienen esa línea (el CCZ 17 de mayor mediana en velocidad no es el mayor con mediana de conteo, pero sí se ubica entre aquellos con mayor registro).

Considerando la observación antes realizada en cuanto a los resultados obtenidos de la descripción de los datos de conteo, la Figura \@ref(fig:boxplot_conteo) muestra el conteo vehicular segun Centro Comunal Zonal distinguiendo por momento del mes. A priori, no se esperaría que estos flujos sean disímiles a lo largo del mes. Sin embargo, por la propia dinámica de movilidad concentrada en el centro de la capital, adicionado a que hay mayor control (en términos de cantidad de cámaras de CGM) en dichos puntos de la ciudad. Los CCZ 2 y 5 son aquellos que muestran mayor volumen en cuanto a la cantidad de vehículos que circulan. En contrapartida, los CCZ 12 y 17 son aquellos con menor movilidad. Estos CCZ se corresponden, en el primer caso a los barrios centro y Punta Carretas; mientras que en los últimos casos se corresponden a los barrios Colón y Cerros, barrios alejados del centro de movilidad laboral y comercial de Montevideo.


```{r barplot_conteo, echo=FALSE, warning=FALSE,message=FALSE, fig.cap="Conteo vehicular según Centro Comunal Zonal discriminando por momento del mes."}
base %>% 
  mutate(CCZ = fct_reorder(CCZ, -volume, .fun = "sum")) %>%
    ggplot(aes(x = CCZ,
               y = volume,
               fill = cat_fecha)) +
    geom_bar(stat = "identity")+
    scale_y_continuous(labels = scales::comma)

```
Sin embargo, así como no se observan sustanciales diferencias en cuanto al conteo vehicular a lo largo del mes, cuando se observa a traves de los días de la semana, como es de esperar, la Figura \ref{fig:barplot_conteo1} muestra que durante los fines de semana, la movilidad se reduce a lo largo de todos los CCZ. Esta observación es más clara en las zonas céntricas de mayor movilidad asociado a que son centros laborales que tienen picos de movilidad durante la semana y valles sobre Sábados y Domingos.

```{r barplot_conteo1, echo=FALSE, warning=FALSE,message=FALSE, fig.cap="Conteo vehicular según Centro Comunal Zonal discriminando por día de la semana."}

base %>% 
  mutate(CCZ = fct_reorder(CCZ, -volume, .fun = "sum")) %>%
    ggplot(aes(x = CCZ,
               y = volume,
               fill = dia_semana)) +
    geom_bar(stat = "identity")+
    scale_y_continuous(labels = scales::comma)

```

Las Figuras \@ref(fig:barplot_velocidad) y \@ref(fig:barplit_velocidad1) muestran de forma análoga el ejercicio anterior, pero considerando el promedio de la velocidad media registrada por las cámaras de CGM. Cuando se observa a lo largo del mes, como parecería intuitivo a priori no se verifican diferencias a lo largo del mes en términos de la velocidad promedio. Sin embargo, cuando se distingue según día de la semana, los fines de semana, probablemente asociado a la menor circulación observada, los registros de velocidad son algo superiores respecto de los restantes días. El CCZ 10 ubicado en las intermediaciones de Jardines del Hipódromo es donde se registran mayores velocidades en comparación al resto de los CCZ.

```{r barplot_velocidad, message=FALSE, echo=FALSE, warning=FALSE, fig.cap="Promedio de la velocidad media registrada por cámaras de CGM, según Centro Comunal Zonal discriminando por momento del mes."}

base %>% 
  group_by(cat_fecha, CCZ) %>% 
    summarise(promedio_vel = mean(velocidad_promedio)) %>% 
      mutate(CCZ = fct_reorder(CCZ, -promedio_vel, .fun = "sum")) %>%
    ggplot(aes(x = CCZ,
               y = promedio_vel,
               fill = cat_fecha)) +
    geom_bar(stat = "identity")+
    scale_y_continuous(labels = scales::comma)



```

```{r barplot_velocidad1, eval=FALSE, message=FALSE, echo=FALSE, warning=FALSE, fig.cap="Promedio de la velocidad media registrada por cámaras de CGM, según Centro Comunal Zonal discriminando por momento del mes."}

base %>% 
  group_by(dia_semana, CCZ) %>% 
    summarise(promedio_vel = mean(velocidad_promedio)) %>% 
      mutate(CCZ = fct_reorder(CCZ, -promedio_vel, .fun = "sum")) %>%
    ggplot(aes(x = CCZ,
               y = promedio_vel,
               fill = dia_semana)) +
    geom_bar(stat = "identity")+
    scale_y_continuous(labels = scales::comma)
```





```{r guardar_datos_app, echo = FALSE, eval = FALSE}
saveRDS(base, "data/processed/base_app.rds")
```


# Descripción de la Aplicación Shiny

Adicionalmente al estudio descriptivo realizado en la sección anterior que resume y busca explicar los objetivos planteados en términos de conteo vehicular y velocidad promedio, se desarrolla una aplicación web a traves de la plataforma R-Shiny. Esta aplicación permite realizar visualizaciones reactivas e interactivas que permiten contribuir a los objetivos observando los volumenes y velocidades de vehiculos según distintos escenarios: momentos del mes, del día, días de la semana, centros comunales zonales, entre otros. 

En este caso la aplicación cuenta de tres principales partes distinguidas a partir de tres pestañas: una primer pestaña que contiene el mapa de Montevideo dividido según CCZ donde se permite observar el volumen vehicular bajo distintos esquemas: categorías del mes, día, día de la semana y CCZ. Se puede visualizar como fluctua el conteo vehícular bajo distintos esquemas a fin de lograr identificar alguna caracterización de la movilidad urbana. 

Una segunda pestaña contiene dos gráficos de mosaicos: uno para la velocidad promedio y otro para el conteo vehicular. Esta herramienta permite visualizar como se comportan los indicadores cuando se cruzan modalidades de las distintas variables cualitativas insertas en el menú desplegable disponible. La nitidez del color de cada celda refleja distintos niveles de los indicadores formulados en función de las modalidades de las variables que se permiten cruzar en el análisis. 

Por último, una tercer herramienta de visualización disponible en la aplicación Shiny permite visualizar algunas descriptivas generales en cuanto a velocidad y volumen. Se proponen herramientas de visualización de conteo distinguiendo por momento del mes, velocidades promedio asociados a los CCZ y otras descriptivas insertas en formato cuadro visualizando según días de la semana descriptivas de los indicadores principales en este trabajo.

Se puede acceder a la aplicación a partir del sigueinte link: https://fgolffeld.shinyapps.io/Proyecto/


# Consideraciones Finales

Este estudio toma datos de fuentes departamentales sobre datos de conteo vehícular y velocidades promedios capturadas por las cámaras del Centro de Gestión de Movilidad. Se propone un análisis descritivo en términos de estos indicadores a fin de lograr caracterizar las relacioes existentes entre velocidad y volumen. A su vez, se introduce información geográfica a los datos de velocidad y conteo a fin de ampliar el análisis localizando mayores velocidades promedios o mayor concentración vehicular. 

Se realizan correlaciones cruzadas entre correlaciones, diagramas de dispersión con sus rectas de regresión asociadas y mapas que complementan lo anterior localizando las observaciones según Centro Comunal Zonal. 

Se encuentra que existen relaciones de asociación o correlaciones positivas entre las velocidades promedios y los volúmenes vehiculares registrados por las cámaras de CGM. Esto se alinea a lo encontrado por Naranjo-Torres (2015) donde mayor cantidad de vehículos promueve que los conductores dinamicen su circulación acrecentando sus velocidades, en promedio. Se encuentra que la velocidad es algo superior durante la madrugada y la noche y mayor conteo vehicular durante el medio día y la media tarde. 

Por otro lado localizando estas observaciones según CCZ se encuentra mayor cantidad de vehículos así como mayor velocidad promedio de circulación en el CCZ ubicado en la zona de Punta Carretas. Esto resulta clave a fin de que los hacedores de políticas públicas departamentales consideren que una zona comercial, muy habitada cuente con máximas velocidades promedio y que justo coincida con la zona de máxima circulación. Sin embargo, lo anterior se deduce considerando los máximos registros. Si se consideran otros estadísticos como la mediana muestral, otros CCZ son los que registran mayor velocidad promedio (Maroñas, Cerro y Carrasco) mientras que Centro y Aguada (zonas de gran tráfico vehicular) cuentan con menor mediana de velocidad promedio. 

Por último, no se observan sustanciales diferencias cuando se consideran momentos del mes, y se observan mínimas diferencias cuando se consideran los indicadores según día de la semana (reduciendo la movilidad durante los fines de semana). Estas conclusiones se extienden a lo largo de los 17 municipios.

A partir de lo anterior se logra una primera aproximación a una caracterización de la movilidad urbana detectando relaciones de asociación entre volumen y velocidad promedio de vehículos junto con una localización geográfica categorizada a partir de los CCZ. Esto sirve de insumo a los municipios y a la IM a fin de lograr optimizar la movilidad y contruir políticas que sigan los lineamientros del CGM formulados por la IM.

Como trabajo futuro se puede extender este estudio con técnicas más sofisticadas de análisis exploratorio multivariado, a fin de lograr caracterizar perfiles de zonas asociadas a su comportamiento en el tránsito. Se pueden desarrollar técnicas de análisis factoria o análisis de clusters para un mejor aproximación y especificidad de los resultados a fin de focalizar mejor las políticas formuladas en pro a un mejor bienestar. Otra propuesta puede venir dada por herramientas de análisis que permitan optimizar la velocidad promedio que optimice la cantidad de vehículos que circulan en la capital. Para ello se pueden desarrollar y estimar modelos econométricos (como por ejemplo regresiones lineales que incluyan la dinámica temporal de los datos - dado que se enceuntran disponibles).



# Referencias

[1] Catálogo de Datos Abiertos. Conteo de Vehículos del Centro de Gestión de Movilidad. Febrero 2021 https://catalogodatos.gub.uy/dataset/intendencia-montevideo-conteo-de-vehiculos-del-centro-de-gestion-de-la-movilidad/resource/b985762d-c1c1-4dd0-bc57-6c3ab53e8ff8


[2] Catálogo de Datos Abiertos. Conteo de Vehículos del Centro de Gestión de Movilidad. Marzo 2021 https://catalogodatos.gub.uy/dataset/intendencia-montevideo-conteo-de-vehiculos-del-centro-de-gestion-de-la-movilidad/resource/6df7fc9c-8331-4d93-928c-cd69b48940a2

[3] Catálogo de Datos Abiertos. Velocidad promedio vehicular en las principales avenidas de montevideo. Febrero 2021 https://catalogodatos.gub.uy/dataset/intendencia-montevideo-velocidad-promedio-vehicular-en-las-principales-avenidas-de-montevideo/resource/01ba56d8-2dab-4d8b-8391-d03159314144

[4] Catálogo de Datos Abiertos. Velocidad promedio vehicular en las principales avenidas de montevideo. Marzo 2021 https://catalogodatos.gub.uy/dataset/intendencia-montevideo-velocidad-promedio-vehicular-en-las-principales-avenidas-de-montevideo/resource/da56b7db-dcef-41e0-8f16-a00406ae7c1c?view_id=abf43575-848a-40a7-94a3-dd9c378ff988

[5] https://negocios.elpais.com.uy/noticias/venta-autos-cero-kilometro-aumento-marzo-marcas-compradas.html

[6] Naranjo-Torres, D. (2015). Análisis de la relación velocidad-densidad vehicular de la avenida calle 26 en Bogotá. Ingenio Magno, 6(1), 76-88.

[7] https://www.gub.uy/unidad-nacional-seguridad-vial/comunicacion/publicaciones/volante-hay-limites-velocidad