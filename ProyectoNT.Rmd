---
title: 'Estudio de circulación vehicular en Montevideo: febrero-marzo 2021'
author: ''
date: ''
output:
  pdf_document:  default
  html_document:
    df_print: paged
header-includes: \usepackage{float} \floatplacement{figure}{H}
---
```{r setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Librerías utilizadas
library(dplyr)
library(date)
library(lubridate)
library(ggplot2)
library(tidyverse)
library(kableExtra)
library(rgdal)
library(maptools)
library(sf)
library(GGally)
library(data.table)
```

```{r data_source, echo = FALSE, include = FALSE}
# Carga deL join
base <- readRDS("data/processed/febrero_marzo_join.rds")

# carga del shapefile
municipios <- st_read("data/geo/mdeo_barrios")
st_crs(x = municipios) <-  5382
```

```{r manejo_fechas, echo = FALSE, include = FALSE}
# Preparamos los datos
base$fecha <- ymd(base$fecha)  

base$fecha <- format(as.Date(base$fecha), '%Y-%m-%d')

base$hora <- hms(base$hora)
```

```{r categorizacion, echo = FALSE, include = FALSE}
# Categorizamos las horas en mañana (8-12), tarde (12-17), media tarde (17-20), noche (20-00) y madrugada (00-8)

base$cat_hora <- ifelse(base$hora >= "08H 00M 0S" & base$hora < "12H 00M 0S",
                        "Mañana",
                        ifelse(base$hora >= "12H 00M 0S" & base$hora < "17H 00M 0S",
                               "Medio dia",
                               ifelse(base$hora >= "17H 00M 0S" & base$hora < "20H 00M 0S",
                                      "Media tarde",
                                      ifelse(base$hora >= "20H 00M 0S" & base$hora < "23H 59M 59S",
                                             "Noche",
                                             "Madrugada"
                                      )
                               )
                        )
)

base$cat_hora <- factor(base$cat_hora,
                        levels = c("Madrugada",
                                   "Mañana",
                                   "Medio dia",
                                   "Media tarde",
                                   "Noche"),
                        ordered = T)


base$cat_fecha <- ifelse(
  (base$fecha >= "2021-02-01" &
     base$fecha <= "2021-02-10") |
    (base$fecha >= "2021-03-01" & base$fecha <= "2021-03-10"),
  "Principio de mes",
  ifelse((base$fecha >= "2021-02-11" &
            base$fecha <= "2021-02-20") |
           (base$fecha >= "2021-03-11" &  base$fecha <= "2021-03-20"),
         "Mitad de mes",
         "Fin de mes"
  )
)

base$cat_fecha <- factor(base$cat_fecha,
                         levels = c("Principio de mes",
                                    "Mitad de mes",
                                    "Fin de mes"),
                        ordered = T)

      
base$dia_semana <- factor(wday(base$fecha),
                          labels = c("1" = "Domingo",
                                     "2" = "Lunes",
                                     "3" = "Martes",
                                     "4" = "Miercoles",
                                     "5" = "Jueves",
                                     "6" = "Viernes",
                                     "7" = "Sabado"))

base <- subset(base, select = -c(hora,
                                 dsc_avenida,
                                 dsc_int_anterior,
                                 dsc_int_siguiente,
                                 i.dsc_avenida,
                                 i.dsc_int_anterior,
                                 i.dsc_int_siguiente))

base$CCZ <- factor(base$CCZ, levels = c(1:17))
```

\begin{center}
\begin{LARGE}
	Nuevas Tecnologías para el análisis de datos
	\vspace{1cm}
	
	""
\vspace{1cm}

	Autores:
	Federico Golffeld - Martín Olivera - Lorena Perez - Ángela Vieyto
	
	\vspace{1cm}
	
	
	`r Sys.Date()`
	
\end{LARGE}
\end{center}	

\vspace{5cm}


\newpage


# Inroducción

En general se ha observado una tendencia creciente en la circulación vehicular en las ciudades, Esto se asocia directamente a un mayor volumen de vehículos, lo que genera mayores tiempos de circulación, enlentecimiento de la movilidad urbana y mayores posibilidades de cometer faltas o accedentes de tránsito, cuando las ciudades no logran adaptarse a dicha coyuntura. Por otro lado, y vinculado a lo anterior, un mayor volumen de vehículos conlleva a un enlentecimiento en los tiempos de movilidad, que genera un comportamiento espontáneo de los conductores en usar como regulación de este fenómeno, la velocidad de circulación. Por parte de las autoridades de las ciudades se ha hecho continuos esfuerzos por combatir esta problemática con estrictas regulaciones a la velocidad y control vehicular. 

En particular, en la capital del país, la Intendencia de Montevideo (IM) a partir de su Departamento de Movilidad en conjunto con el Ministerio de Transporte y Obras Públicas (MTOP) son quienes se encargan de este tipo de regulaciones, no solo a nivel de calles sino de cartelera y señalizaciones, muchas veces a partir de la incorporación de un sistema de monitoreo digital con vídeo en ciertos puntos de la ciudad. El Centro de Gestión de Movilidad (CGM) de la IM es quien se encarga de esta tarea, monitoreando y tomando registro de lo acontecido a partir de las cámaras de vídeo-vigilancia. 

Por esto, el objetivo general de este trabajo se basa en un estudio de las velocidades de los vehículos que circulan en Montevideo en conjunto con la cantidad de vehículos que se logran capturar a partir del CGM. En particular surge el interés de estudiar geográficamente los volúmenes de circulación y su asociación con las velocidades registradas. Por otro lado, estudiar aquellos puntos con mayores registros de velocidad y aquellos con menores registros a fin de capturar la potencial necesidad de regulación en ciertos puntos de la capital. Además, puede ser de interés el estudio día a día de los volúmenes y las velocidades registradas a fin de observar algún patrón entre febrero y marzo, en términos de días de la semana y horarios donde la circulación es máxima o que logra minimizar las velocidades de circulación. Estos elementos en su conjunto pueden contribuir a la detección de potenciales aplicaciones de políticas departamentales que desemboquen en una ciudad "amigable" en términos de la circulación urbana.

En lo que sigue de este trabajo se propone realizar una descripción de los datos a utilizar en términos de su fuente de obtención, tipos de datos, cantidad de observaciones, variables, entre otras. Más adelante en futuro desarrollo de este trabajo se profundizar en análisis exploratorios que permitan discernir en función de los objetivos planteados.



\newpage



# Datos

Para realizar este estudio se consideran datos brindados por el Centro de Gestión de Movilidad (CGM) del Departamento de Movilidad de la Intendencia de Montevideo (IM). Se cuentan con datos con frecuencia mensual referentes a la velocidad de circulación y el volumen de circulación de vehículos en la ciudad de Montevideo donde se detallan los registros de las cámaras de CGM con día y horario de lo acontecido. Para este ejercicio se consideran datos para los meses de Febero y Marzo de 2021 - "El sistema genera un registro cada 5 minutos, las medidas que se explican a continuación corresponden a la suma de todos los vehículos de los 5 minutos anteriores a la fecha y hora del registro. También se publican datos particulares del sensor que permiten conocer su ubicación y entender el sentido de circulación que se está midiendo". Cabe destacar la particularidad de que en los meses de verano la movilidad suele ser inferior a otros meses del año y considerando un contexto de pandemia, estos datos pueden estar afectados a la coyuntura.

Por tanto, se cuenta con 7623354 observaciones correspondiente a Febrero y Marzo de 2021 para cada una de las bases de datos utilizadas: la velocidad de circulaci+on vehicular y el volumen de circulación. En cuanto al set de variables consideradas, los datos vinculados a la velocidad de circulación cuenta con 10 variables mientras que los datos de conteo vehicular cuenta con 11 observaciones. Sin embago, considerando que hay variables idénticas en ambas fuentes de datos, en total se cuenta con 12 variables. La siguiente tabla base el set de variables consideradas en este estudio con su debida descripción. 

```{r, echo = FALSE}
variables <-
  c(
    "i..cod_detector",
    "id_carril",
    "fecha",
    "hora",
    "dsc_avenida",
    "dcs_int_anterior",
    "dsc_int_siguiente",
    "latitud",
    "longitud",
    "velocidad_promedio",
    "volume",
    "volumen_hora")

descripcion <-
  c(
    "Id de la cámara que está monitoerando un determinado carril",
    "Número del carril que se está monitoreando",
    "Día en que se toma la base",
    "Hora en que se toma la base",
    "Nombre de la vía en la que se mide el tránsito",
    "Nombre de la vía que forma el cruce desde donde vienen los vehículos",
    "Nombre de la vía que forma el cruce donde está el medidor",
    "Latitud de donde está el medidor",
    "Longitud de donde está el medidor",
    "Promedio de  las velocidades de los autos que circularon por el carril durante los últimos 5 minutos",
    "Cantidad de vehículos detectados en el carril en los últimos 5 minutos",
    "Cantidad de vehículos detectados en el carril en la última hora"
  )

tabla_variables <- data.frame(cbind(variables, descripcion))

colnames(tabla_variables) <- c("Variables", "Descripción")

tabla_variables %>%
  kable(booktabs = T,
        caption = "Tabla resumen de las variables del set de Datos") %>%
    kable_styling(latex_options = c("striped", "hold_position"))
```

Respecto a las variables anteriores, la longitud y la latitud son variables de tipo "float", mientras que las vías son textos y las restantes son variables numéricas en el conjunto de los números enteros, a excepción de aquellas vinculadas a días y horas. Estas variables tienen un formato propio y fueron cohesionadas a formato `Date` para su correcto tratamiento. Dada la gran cantidad de observaciones con las que contamos, decidimos categorizar las variables fecha y hora, en ambas bases, de la siguiente forma: 

```{r echo = FALSE}
categorias <-
  c(
    "Principio de mes",
    "Mitad de mes",
    "Fin de mes",
    "Mañana",
    "Medio día",
    "Media tarde",
    "Noche",
    "Madrugada"
  )

descripcion_2 <- c(
  "Del 1 al 10 de cada mes",
  "Del 11 al 20 de cada mes",
  "Del 21 al 28 en el caso de Febrero, y del 21 al 31 en el caso de Marzo",
  "De las 8.00 a las 12.00",
  "De las 12.01 a las 17.00",
  "De las 17.01 a las 20.00",
  "De las 20.01 a las 00.00",
  "De las 00.01 a las 7.59"
)

tabla_variables2 <- data.frame(cbind(categorias, descripcion_2))

colnames(tabla_variables2) <- c("Categorización", "Descripción")

tabla_variables2 %>%
  kable(booktabs = T,
        caption = "Tabla resumen de las categorías creadas para Fecha y Hora") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

A partir de una tabla de frecuencias se obtiene que el 32% de los vehículos capturados por las cámaras (variables volumen y velocidad) ocurren a principio de mes, el 33% sobre mediados de mes y un 35% sobre fin de mes. A simple vista, y sin realizar un análisis más profundo, no pareciera haber grandes diferencias, en términos generales, en el volumen de vehículos en el correr del mes.

En cuanto al volumen de vehículos capturado por la cámara en los últimos 5 minutos, se observa un promedio total de 17 vehículos, mientras si discriminamos por mes, se obtiene un promedio de 16 y 17, para febrero y marzo, respectivamente. Por otro lado, se observa una velocidad promedio de 30.9 km/h si tomamos en cuenta la totalidad de las observaciones, mientras que asciende levemente a 31.0 km/h para el mes de febrero y se ubica en 30.8 km/h para el mes de marzo. Los resultados siguen esta misma línea si consideramos la categorización anteriormente mencionada para la fecha de los registros; 30.8km/h para los primeros 10 días del mes, 31.0 km/h para mitad de mes y fin de mes.  

Por último, observamos los desvíos de las variables Volumen y Velocidad promedio, y luego la correlación entre ambas. La primera de las mencionadas tiene una desviación estándar de 18.6, mientras que la segunda una de 17.0. Mirando el coeficiente de correlación, se observa que este es de 0.02, indicando una correlación baja, lo que podrá llegar a ser contra intuitivo.

```{r boxplot}
# Boxplots por municipios --- lo dejo escrito en comentario porque queda unificar los municipios de cada obs a la base original y a la base

p1 <- base %>%
        ggplot(aes(x = reorder(factor(CCZ), -velocidad_promedio,median),
                   y = velocidad_promedio)) + 
        geom_boxplot()  +
        labs(x = "Centro comunal zonal",
             y = "Velocidad Promedio") 

p2 <- base %>%
        ggplot(aes(x = reorder(factor(CCZ), -volume, median),
                   y = volume)) +
        geom_boxplot() +
        labs(x = "Centro comunal zonal",
             y = "Conteo de Vehiculos") 

grid.arrange(p1, p2, nrow = 1, ncol = 2)
```

```{r boxplot}
base %>%
  ggplot(aes(x = volume,
             y = velocidad_promedio)) +
  geom_point(alpha = 1/3) +
  labs(x = "Cantidad de vehículos detectados", 
       y = "Velocidad promedio") +
  theme(aspect.ratio = 1,
        legend.title = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.x = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.y = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.text.x = element_text(size = 8,
                                   angle = 45,
                                   hjust = 1)
        ) +
  facet_wrap( ~cat_hora,
              ncol = 5) +
  geom_smooth(method = "lm")
```

```{r boxplot}
# Dispersion: velocidad x conteo faceteado por hora, momento del mes, ...

base %>%
  ggplot(aes(x = volume,
             y = velocidad_promedio)) +
  geom_point(alpha = 1/3) +
  labs(x = "Cantidad de vehículos detectados", 
       y = "Velocidad promedio") +
  theme(aspect.ratio = 1,
        legend.title = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.x = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.y = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.text.x = element_text(size = 8,
                                   angle = 45,
                                   hjust = 1)
        ) +
  facet_wrap( ~dia_semana,
              ncol = 3) +
  geom_smooth(method = "lm")
```

```{r boxplot}
# Dispersion: velocidad x conteo faceteado por hora, momento del mes, ...

base %>%
  ggplot(aes(x = volume,
             y = velocidad_promedio)) +
  geom_point(alpha = 1/3) +
  labs(x = "Cantidad de vehículos detectados", 
       y = "Velocidad promedio") +
  theme(aspect.ratio = 1,
        legend.title = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.x = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.title.y = element_text(size = 8,
                                    face = "bold",
                                    hjust = 0.5),
        axis.text.x = element_text(size = 8,
                                   angle = 45,
                                   hjust = 1)
        ) +
  facet_wrap( ~cat_fecha,
              ncol = 3) +
  geom_smooth(method = "lm")
```

ggplot(base, aes(x = cat_fecha, y = cat_hora, fill = velocidad_promedio)) + geom_tile() 

ggplot(base, aes(x = cat_hora, y = dia_semana, fill = velocidad_promedio)) + geom_tile()

ggplot(base, aes(x = cat_fecha, y = dia_semana, fill = velocidad_promedio)) + geom_tile()

ggplot(base, aes(x = cat_fecha, y = cat_hora, fill = volume)) + geom_tile()

ggplot(base, aes(x = cat_hora, y = dia_semana, fill = volume)) + geom_tile()

ggplot(base, aes(x = cat_fecha, y = dia_semana, fill = volume)) + geom_tile()

```{r barplot_conteo}
# Barras: dias de la semana (cada barra por municipio)

base %>% 
  ggplot(aes(x = cat_fecha,
             y = volume)) +
  geom_col() +
  facet_wrap(~factor(CCZ)) # Separar por CCZ 

```

```{r barplot_conteo}
# Barras: dias de la semana (cada barra por municipio)

base %>% 
  group_by(cat_fecha, CCZ) %>% 
    summarise(promedio_vel = mean(velocidad_promedio)) %>% 
      ggplot(aes(x = cat_fecha,
                 y = promedio_vel)) +
      geom_col(stat = 'identity') +
      facet_wrap(~factor(CCZ)) # Separar por CCZ 

```

```{r barplot}
base %>% 
  mutate(CCZ = fct_reorder(CCZ, -volume, .fun = "sum")) %>%
    ggplot(aes(x = CCZ,
               y = volume,
               fill = cat_fecha)) +
    geom_bar(stat = "identity")+
    scale_y_continuous(labels = scales::comma)
```

base %>% 
  ggplot(aes(x = reorder(CCZ, -as.numeric(volume)),
              y = volume)) +
  geom_bar(stat = "identity")

<!-- NO LOGRAMOS ORDENAR LAS BARRAS EN EL EJE X-->


```{r barplot_valocidad}
base %>%
  filter(velocidad_promedio > 0) %>%
    group_by(dia_semana, CCZ) %>% 
      summarise(Mínimo = min(velocidad_promedio),
                Máximo = max(velocidad_promedio)) %>%
        pivot_longer(cols = c(CCZ, Mínimo, Máximo),
                     names_to = "Valores") %>%
          ggplot(aes(x = dia_semana,
                     y = value,
                     fill = Valores)) +
          geom_col(position = "dodge", 
                   stat = "identity") + 
          labs(y ="Velocidad promedio en los últimos 5 minutos (km/h)", 
               title = "Mínima y máxima velocidad promedio registrada por día de la semana") +
          geom_text(aes(label = paste(value, "km/h")),
                    colour = "white",
                    size = 2,
                    vjust = 1.5, 
                    position = position_dodge(.9)) +
          theme(
            axis.title.x = element_blank(),
            legend.title = element_blank(),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.title.y = element_text(size = 10,
                                        hjust = 0.5),
            legend.text = element_text(size = 6),
            axis.text = element_text(size = 6)
          ) + 
          scale_fill_manual(values = c("#d9421c", "#54e84f")) +
          facet_wrap(~factor(CCZ))# Separar por municipio 

# Acá me imaginé que en cada día haya dos barras, una de min y una de max, pero creo que no se puede graficar dos variables distintas en el eje y. ¿Ideas?

```

```{r barplot_valocidad}
base %>%
  filter(velocidad_promedio > 0) %>%
    group_by(dia_semana, cat_hora) %>%
      summarise(Mínimo = min(velocidad_promedio),
                Máximo = max(velocidad_promedio)) %>%
        pivot_longer(cols = c(Mínimo, Máximo),
                     values_to = "Valores") %>%
          ggplot(aes(x = dia_semana,
                     y = value,
                     fill = Valores)) +
          geom_col(position = "dodge",
                   stat = "identity") +
          labs(y = "Velocidad promedio en los últimos 5 minutos (km/h)",
               title = "Mínima y máxima velocidad promedio registrada por día de la semana") +
          geom_text(
            aes(label = paste(value, "km/h")),
            colour = "white",
            size = 2,
            vjust = 1.5,
            position = position_dodge(.9)
          ) +
          theme(
            axis.title.x = element_blank(),
            legend.title = element_blank(),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.title.y = element_text(size = 10,
                                        hjust = 0.5),
            legend.text = element_text(size = 6),
            axis.text = element_text(size = 6)
          ) +
          scale_fill_manual(values = c("#d9421c", "#54e84f")) +
          facet_grid(. ~ cat_hora)

#Se me ocurrio hacerlo tambien general, por momento del dia, si no les parece lo borramos. Igual lo que no me esta quedando es el pivot_long, me dice que no lo puede hacer por no ser multiplos. Pero la variable cat_hora no la quiero tocar

```

```{r correlacion}
#Graficos de correlaciones. Se puede extender a municipios.
ggpairs(base, c("volume", "velocidad_promedio"),
        mapping = ggplot2::aes(color = cat_hora,
                               alpha = 0.5),
        diag = list(continuous = wrap("densityDiag")),
        lower = list(continuous = wrap("points",
                                       alpha = 0.9)))

ggpairs(base, c("volume", "velocidad_promedio"),
        mapping = ggplot2::aes(color = dia_semana,
                               alpha = 0.5),
        diag = list(continuous = wrap("densityDiag")),
        lower = list(continuous = wrap("points",
                                       alpha = 0.9)))

ggpairs(base, c("volume", "velocidad_promedio"),
        mapping = ggplot2::aes(color = cat_fecha,
                               alpha = 0.5),
        diag = list(continuous = wrap("densityDiag")),
        lower = list(continuous = wrap("points",
                                       alpha = 0.9)))
```

```{r}
base %>%
 group_by(CCZ) %>%
  summarise(velocidad_minima = min(velocidad_promedio),
            velocidad_maxima = max(velocidad_promedio),
            volumen_minimo = min(volume),
            volumen_maximo = max(volume))
```

```{r map, echo = FALSE, include = FALSE}
# Grafica test

ggplot() +
  geom_sf(data = municipios) +  
  geom_sf(data = base, aes(fill = volume)) +
  theme_minimal()
```

```{r guardar_datos_app, echo = FALSE, eval = FALSE}
saveRDS(base, "data/processed/base_app.rds")
```

## Referencias

[1] Catálogo de Datos Abiertos. Conteo de Vehículos del Centro de Gestión de Movilidad. Febrero 2021 https://catalogodatos.gub.uy/dataset/intendencia-montevideo-conteo-de-vehiculos-del-centro-de-gestion-de-la-movilidad/resource/b985762d-c1c1-4dd0-bc57-6c3ab53e8ff8

[2] Catálogo de Datos Abiertos. Conteo de Vehículos del Centro de Gestión de Movilidad. Marzo 2021 https://catalogodatos.gub.uy/dataset/intendencia-montevideo-conteo-de-vehiculos-del-centro-de-gestion-de-la-movilidad/resource/6df7fc9c-8331-4d93-928c-cd69b48940a2

[3] Catálogo de Datos Abiertos. Velocidad promedio vehicular en las principales avenidas de montevideo. Febrero 2021 https://catalogodatos.gub.uy/dataset/intendencia-montevideo-velocidad-promedio-vehicular-en-las-principales-avenidas-de-montevideo/resource/01ba56d8-2dab-4d8b-8391-d03159314144

[4] Catálogo de Datos Abiertos. Velocidad promedio vehicular en las principales avenidas de montevideo. Marzo 2021 https://catalogodatos.gub.uy/dataset/intendencia-montevideo-velocidad-promedio-vehicular-en-las-principales-avenidas-de-montevideo/resource/da56b7db-dcef-41e0-8f16-a00406ae7c1c?view_id=abf43575-848a-40a7-94a3-dd9c378ff988